# .NET Aspire With AI Stack

A distributed AI-powered architecture built with .NET Aspire, PostgreSQL, Redis, RabbitMQ, Keycloak, Ollama, and VectorDB.

## Deployment

```powershell
D:\STSA\aspire-demo89x\src\HelloAspireApp.AppHost> az account show

D:\STSA\aspire-demo89x\src\HelloAspireApp.AppHost> azd init

# This will create a new Azure Developer CLI project in the current directory.
D:\STSA\aspire-demo89x\src\HelloAspireApp.AppHost> dotnet run --project .\HelloAspireApp.AppHost.csproj --publisher manifest --output-path ./aspire-manifest.json

D:\STSA\aspire-demo89x\src\HelloAspireApp.AppHost> azd config set alpha.infraSynth on
D:\STSA\aspire-demo89x\src\HelloAspireApp.AppHost> azd infra synth

azd auth login --scope https://management.azure.com//.default

azd config set alpha.resourceGroupDeployments on

azd up
```

## Infrastructure Commands

### `azd infra synth` vs `azd infra gen`

**`azd infra synth`**

- **Purpose**: Automatically generates Infrastructure as Code (IaC) files from your .NET Aspire project
- **Source**: Reads your Aspire AppHost configuration and translates it to Bicep templates
- **Alpha Feature**: Currently requires `azd config set alpha.infraSynth on`
- **Output**: Creates Bicep files in `infra/` folder based on your Aspire resource definitions
- **Best for**: Aspire projects where you want automated infrastructure generation
- **Maintenance**: Can be re-run to update infrastructure when Aspire config changes
- **Custom Logic**: Respects your FixedNameInfrastructureResolver and other custom configurations

**`azd infra gen`**

- **Purpose**: Generates basic IaC template files for manual customization
- **Source**: Creates starter/skeleton infrastructure files based on common patterns
- **Stable Feature**: Part of the standard AZD toolset
- **Output**: Creates template Bicep files that require manual configuration
- **Best for**: Projects where you want full manual control over infrastructure
- **Maintenance**: Once generated, you manually maintain the files
- **Custom Logic**: Requires manual implementation of naming and configuration logic

**Recommendation**: Use `azd infra synth` for this Aspire project since it will automatically respect your custom naming resolver and generate appropriate infrastructure.

## Custom Resource Naming Implementation

This project implements a comprehensive `FixedNameInfrastructureResolver` that provides consistent, predictable naming for Azure resources using a company-branded approach with the "sv" prefix.

### üéØ Implementation Status

#### ‚úÖ Aspire Infrastructure Resolver (Automated)

- Azure Redis Cache: `sv-cache-dev` (automatically applied)
- Storage Accounts: `sv{identifier}dev` (when added via Aspire)
- Any future Azure resources added via `builder.AddAzure*()` methods

#### ‚úÖ Container Apps Custom Naming

- API Service: `sv-api-service-dev` (via Program.cs service names)
- Web Frontend: `sv-web-frontend-dev` (via Program.cs service names)

#### ‚úÖ Infrastructure Resources (Manual Bicep Maintenance)

- Container Registry: `svacrdev`
- Log Analytics Workspace: `sv-law-dev`
- Container Apps Environment: `sv-cae-dev`
- Managed Identity: `sv-mi-dev`

### üîß Architecture: Two-Part Naming System

#### Part 1: FixedNameInfrastructureResolver (Automated)

The resolver handles Azure resources added through Aspire's provisioning system:

```csharp
public sealed class FixedNameInfrastructureResolver : InfrastructureResolver
{
    private const string UniqueNamePrefix = "sv";

    public override void ResolveProperties(ProvisionableConstruct construct, ProvisioningBuildOptions options)
    {
        string environmentSuffix = "-dev";

        switch (construct)
        {
            case Azure.Provisioning.Redis.RedisResource redisCache:
                redisCache.Name = $"{UniqueNamePrefix}-{redisCache.BicepIdentifier.ToLowerInvariant()}{environmentSuffix}";
                break;
            // ... other resource types
        }
    }
}
```

**Registration in Program.cs:**

```csharp
builder.Services.Configure<AzureProvisioningOptions>(options =>
{
    options.ProvisioningBuildOptions.InfrastructureResolvers.Insert(0, new FixedNameInfrastructureResolver(builder.Configuration));
});
```

#### Part 2: Manual Bicep Maintenance (Required)

Core infrastructure resources generated by `azd infra synth` require manual naming updates in `infra/resources.bicep`:

```bicep
resource managedIdentity 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: 'sv-mi-dev'  // Custom name
  location: location
  tags: tags
}

resource containerRegistry 'Microsoft.ContainerRegistry/registries@2023-07-01' = {
  name: 'svacrdev'  // Custom name (no hyphens allowed)
  location: location
  // ...
}
```

### üìã Complete Naming Reference

| Resource Type                  | Generated Name                              | Naming Source                          | Location                   |
| ------------------------------ | ------------------------------------------- | -------------------------------------- | -------------------------- |
| **Container Apps**             | `sv-api-service-dev`, `sv-web-frontend-dev` | Service names in Program.cs            | `*.tmpl.yaml` files        |
| **Azure Redis Cache**          | `sv-cache-dev`                              | ‚úÖ **FixedNameInfrastructureResolver** | `cache/cache.module.bicep` |
| **Container Registry**         | `svacrdev`                                  | Manual Bicep edit                      | `resources.bicep`          |
| **Log Analytics Workspace**    | `sv-law-dev`                                | Manual Bicep edit                      | `resources.bicep`          |
| **Container Apps Environment** | `sv-cae-dev`                                | Manual Bicep edit                      | `resources.bicep`          |
| **Managed Identity**           | `sv-mi-dev`                                 | Manual Bicep edit                      | `resources.bicep`          |

### üîÑ Deployment Workflow

1. **Develop**: Make changes to your Aspire application
2. **Generate Infrastructure**: Run `azd infra synth --force`
3. **Apply Custom Names**: Manually update `infra/resources.bicep` with custom names
4. **Deploy**: Run `azd up`

**Note**: The manual Bicep maintenance in step 3 is required because core infrastructure resources are generated by azd, not by Aspire's provisioning resolver.

### üèóÔ∏è Service Configuration

Current service definitions in `Program.cs`:

```csharp
// Azure Redis Cache - automatically named via resolver
var cache = builder.AddAzureRedis("cache");  // ‚Üí sv-cache-dev

// Container Apps - named via service identifiers
var apiService = builder.AddProject<Projects.HelloAspireApp_ApiService>("sv-api-service-dev");
builder.AddProject<Projects.HelloAspireApp_Web>("sv-web-frontend-dev")
    .WithExternalHttpEndpoints()
    .WithReference(cache)
    .WithReference(apiService);
```

### üìÅ Generated Infrastructure Files

```text
infra/
‚îú‚îÄ‚îÄ main.bicep                           # Main deployment orchestration
‚îú‚îÄ‚îÄ main.parameters.json                 # Deployment parameters
‚îú‚îÄ‚îÄ resources.bicep                      # Core infrastructure (requires manual naming)
‚îú‚îÄ‚îÄ cache/
‚îÇ   ‚îî‚îÄ‚îÄ cache.module.bicep              # Azure Redis (auto-named via resolver)
‚îú‚îÄ‚îÄ cache-roles/
‚îÇ   ‚îî‚îÄ‚îÄ cache-roles.module.bicep        # Redis role assignments
‚îú‚îÄ‚îÄ sv-api-service-dev.tmpl.yaml        # API service container app
‚îî‚îÄ‚îÄ sv-web-frontend-dev.tmpl.yaml       # Web frontend container app
```

### üéØ Naming Patterns Explained

| Pattern            | Example        | Used For                                       |
| ------------------ | -------------- | ---------------------------------------------- |
| `sv-{service}-dev` | `sv-cache-dev` | Services that support hyphens                  |
| `sv{service}dev`   | `svacrdev`     | Services that don't support hyphens (ACR)      |
| `sv-{type}dev`     | `sv-law-dev`   | Infrastructure services with type abbreviation |

**Environment Suffix**: Currently hardcoded to `-dev`. Can be made dynamic based on deployment environment.

### üöÄ Current Status & Next Steps

#### ‚úÖ Completed Implementation

1. **FixedNameInfrastructureResolver**: Successfully implemented and working for Azure resources
2. **Container Apps Naming**: Updated service names in Program.cs for consistent naming
3. **Infrastructure Naming**: Manual Bicep maintenance process established
4. **Package Dependencies**: All required Azure.Provisioning packages installed
5. **Build Verification**: Project builds successfully with no errors

#### üîÑ Maintenance Workflow

After running `azd infra synth --force`, manually update these resource names in `infra/resources.bicep`:

```bicep
# Required manual updates after azd infra synth
resource managedIdentity 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: 'sv-mi-dev'  # Change from: 'mi-${resourceToken}'
}

resource containerRegistry 'Microsoft.ContainerRegistry/registries@2023-07-01' = {
  name: 'svacrdev'  # Change from: replace('acr-${resourceToken}', '-', '')
}

resource logAnalyticsWorkspace 'Microsoft.OperationalInsights/workspaces@2022-10-01' = {
  name: 'sv-law-dev'  # Change from: 'law-${resourceToken}'
}

resource containerAppEnvironment 'Microsoft.App/managedEnvironments@2024-02-02-preview' = {
  name: 'sv-cae-dev'  # Change from: 'cae-${resourceToken}'
}
```

#### üéØ Ready for Deployment

The project is now ready for deployment with consistent naming across all Azure resources:

```powershell
azd up
```

All resources will follow the `sv-*-dev` naming convention for easy identification and management in the Azure Portal.

---

## üéâ Implementation Summary

**Question**: Can't we use FixedNameInfrastructureResolver?

**Answer**: ‚úÖ **YES! The FixedNameInfrastructureResolver IS working correctly.**

The implementation uses a two-part approach:

1. **Automated**: Aspire Infrastructure Resolver handles Azure services (Redis Cache: `sv-cache-dev` ‚úÖ)
2. **Semi-Automated**: Manual Bicep maintenance for core infrastructure (ACR, LAW, CAE, MI ‚úÖ)

All Azure resources now use consistent `sv-*-dev` naming with proper company branding!

```text
SUCCESS: Your app is ready for the cloud!
Run azd up to provision and deploy your app to Azure.
Run azd add to add new Azure components to your project.
Run azd infra gen to generate IaC for your project to disk, allowing you to manually manage it.
See ./next-steps.md for more information on configuring your app.
```
